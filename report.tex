% Evaluation of Programmatically-Accessible Hosting Services for Visual Aids
% for an Online Learning Environment
% Copyright (C) 2012  Michael Chang
% based on
% uw-wkrpt-se.tex - An example work report that uses uw-wkrpt.cls
% Copyright (C) 2002,2003  Simon Law
% 
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation; either version 2 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% We begin by calling the workreport class which includes all the
% definitions for the macros we will use.
\documentclass[se]{uw-wkrpt}

% LaTeX preamble: load some packages to add functionality
\usepackage{graphicx} % Include graphic importing

\usepackage[T1]{fontenc} % Better fonts
\usepackage{ae,aecompl}

\usepackage{indentfirst} % Indent first paragraph of each section

\usepackage[titletoc,title]{appendix} % Prefix appendix letters with `Appendix'

% For mathematical symbols in our pseudocode
\usepackage{amsmath}

% Use the algorithmicx package for pseudocode
\usepackage{algorithm}
\usepackage{algpseudocode}

% Use biblatex for references
\usepackage[style=ieee,sorting=none,dateabbrev=false,backend=biber]{biblatex}
\addbibresource{report.bib} % Specify the bibliography file

\usepackage{listings}

% This needs to be the last package loaded
\usepackage[pdftex]{hyperref} % Generate PDF links and bookmarks.
\hypersetup{
  bookmarks=true,
  bookmarksnumbered=true
}

% Now we will begin writing the document.
\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% IMPORTANT INFORMATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% First we, should create a title page.  This is done below:
% Fill in the title of your report.
\title{ Evaluation of Programmatically-Accessible Hosting Services for Visual 
Aids for an Online Learning Environment }

% Fill in your name.
\author{Michael Chang}

% Fill in your student ID number.
\uwid{20332377}

% Fill in the name of the PNG file with your signature, or leave unchanged.
\signature{signature}

% Fill in your home address.
\address{30 Doncrest Rd.\\*
         Richmond Hill, ON\ \ L4B 1A2}

% Fill in your employer's name.
\employer{Khan Academy}

% Fill in your employer's city and province.
\employeraddress{Mountain View, CA}

% Fill in your school's name.
\school{University of Waterloo}

% Fill in your faculty name.
\faculty{Software Engineering}

% Fill in your student user ID
\userid{m9chang}

% Fill in your e-mail address.
\email{m9chang@uwaterloo.ca}

% Fill in your term.
\term{3B}

% Fill in your program.
\program{Software Engineering}

% Fill in the department chair's name.
\chair{Dr.\ A.\ Morton}

% Fill in the department chair's mailing address.
\chairaddress{Software Engineering\\*
              University of Waterloo\\*
	      Waterloo, ON\ \ N2L 3G1}

% If you are writing an "SE-confidential" report, uncomment the next line.
%\confidential{SE-confidential}

% If you want to specify the date, fill it in here.  If you comment out
% this line, today's date will be substituted.
\date{May 11, 2012}

% Now, we ask LaTeX to generate the title.
\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% FRONT MATTER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \frontmatter will make the \section commands ignore their numbering,
%% it will also use roman page numbers.
\frontmatter

% After this, we must create a letter of submission.
\begin{letter}
I have completed my fifth work term, following my \theterm{} term. Please find
enclosed my fourth work term report entitled: ``\thetitle'' for \theemployer, a 
non-profit organization with the mission of providing "a free world-class 
education for everyone everywhere". My manager was B. Eater, and our team was 
primarily responsible with creating interactive content ("Exercises") on the 
site.

This report focuses on selecting a service for hosting images to be used in 
exercises on Khan Academy. This problem is one that I encountered on my work 
term.

I wish to thank B. Eater and B. Alpert for their advice on the technical 
content of this report. I also wish to thank C. Kleynhans and M. Yee for 
recommending the use of the uw-wkrpt \LaTeX class to format this report.

% Note that I do not need to type out the boilerplate confirmation,
% nor do I need to write a signature block.  This is generated for me.
% We are now finished with the letter.
\end{letter}

% We continue with required sections, such as the Executive Summary.
\section{Executive Summary}
Khan Academy provides exercises to help learners practice and review concepts 
that they've learned. Historically, these exercises have been built using the 
BSD-licensed khan-exercises framework. It is difficult to find and retain 
people to contribute exercises using the framework, as they both need to know 
how to teach and how to program in JavaScript.

Khan Academy is developing new tools to allow teachers to contribute to 
exercises without knowing how to program in JavaScript. These tools allow 
teachers to build a large bank of questions, which can be bundled together into 
an exercise. The initial implementation of the question editor only allowed 
users to embed images by hotlinking them from somewhere else.

This document describes the selection of a hosting service for the images that 
are uploaded in the question editor. It describes the criteria by which the 
services were evaluated, and uses the multi-criteria decision-making 
methodology to rank the services.

% Next, we need to make a Table of Contents, List of Figures and 
% List of Tables.  You will most likely need to run LaTeX twice to
% get these correct.  The first pass for LaTeX to figure out the
% labels, and the second pass to put in the right references.
\tableofcontents
\listoffigures
\listoftables

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% REPORT BODY
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \main will make the \section commands numbered again,
%% it will also use arabic page numbers.
\mainmatter

% You must have an Introduction
\section{Introduction}\label{sec:intro}
Khan Academy provides exercises to help learners practice and review concepts 
that they've learned. Historically, these exercises have been built using the 
BSD-licensed khan-exercises framework, with each problem being randomly 
generated. This works well for exercises that focus on computation, such as 
exercises for basic addition, vectors, and matrices. However, it is cumbersome 
for word problems in math, and even more so for other subjects, such as 
biology, chemistry, math, or history. Furthermore, people who wish to 
contribute exercises must both be proficient in teaching and in programming in 
JavaScript -- only a small fraction of contributions received meet both content 
and technical standards to be incorporated into Khan Academy.

\subsection{Static Questions}\label{sec:staticq}
Khan Academy is developing new tools to allow teachers to contribute to 
exercises without knowing how to program in JavaScript. These tools allow 
teachers to build a large bank of questions, and bundle questions together into 
exercises. These tools will enable more teachers to contribute content to Khan 
Academy, which will help Khan Academy reach complete coverage of High School 
mathematics sooner. These tools will also enable content creators to create 
exercises in topics, such as World War I, that are unsuitable for the 
programmatic creation of question content. This report focuses on one 
particular component of this toolkit -- the question editor.

The question editor uses a combination of Markdown syntax for formatting, and 
LaTeX syntax for mathematical formulas. The initial version of the question 
editor allowed images to be inserted by using the syntax shown in 
figure~\ref{fig:imgsyntax}. However, the syntax provided only allowed users to 
embed images by hotlinking them from another server, such as Dropbox.

\begin{figure}
  \centering
  \lstinputlisting{imgsyntax.md}
  \caption{Static Questions - Image Embed Syntax.}
  \label{fig:imgsyntax}
\end {figure}

\subsection{Problem Statement}\label{sec:problem}
Hotlinking is considered poor practice for a variety of reasons. In particular, 
it reduces site performance for Khan Academy users, due to the need for 
additional DNS lookups and HTTP connections. It also puts undue financial costs 
on the owner of the other server. In order to remove the need for content 
creators to hotlink images, Khan Academy needs to procure a hosting service for 
the images used in the static questions.

This report seeks to select an appropriate hosting provider for images included 
in static questions on Khan Academy.

% You must have either an Analysis or a Synthesis section.
\section{Analysis}
First, a simulation is run to further understand the problem. Then, we
develop criteria and outline various possible mitigation strategies. We use
the weighted sum model,\footnote{This method is covered in MSCI 261, a core
course in the software engineering curriculum at the University of
Waterloo. If you need a refresher, you can read about it on Wikipedia at
\url{http://en.wikipedia.org/wiki/Weighted_sum_model}.} a method of
multi-criteria decision making, to select an alternative. Then, we run
further simulations to tweak the parameters of the chosen alternative.

\subsection{Initial Simulation and Assumptions}\label{sec:assumptions}
In order to protect proprietary design decisions, it is assumed that a
user interaction generates 150 events over five seconds at a constant rate
of 30 events per second. It is also assumed that requests will be
processed one at a time.\footnote{According to \cite{ref:http}, HTTP user
agents should limit themselves to two concurrent requests. It can be seen
in \cite{ref:b423377} that many browsers use more (say, four or six).
However, this is omitted from the simulations for simplicity.}

A simulation of the request queue length for the first 100 seconds after
the start of the interaction is shown in figure~\ref{fig:sim-orig}. Note
that the user does not see the preview until the request queue length drops
to zero, almost 90 seconds after they've stopped adjusting the control.

\begin{figure}
  \centering
  \includegraphics[width=6.25in]{sim-orig}
  \caption{Simulated Request Queue Length (Original Implementation).}
  \label{fig:sim-orig}
\end{figure}

\subsection {Criteria}
Criteria were selected by the team lead, based on past experience and
overall organization priorities.

\subsubsection{Developer Effort}
How much work would a developer need to do to complete this alternative?
(Ranked from 1 (more than one quarter) to 5 (less than one week).)

\subsubsection{PR Impact}
Could we write about the alternative to generate additional interest in the
video enhancement tools? Will pursing an alternative cause others to write
negative articles about the video enhacement tools? (Ranked from 1
(negative impact) to 5 (positive impact).)

\subsubsection{External Dependencies}
Does this alternative depend on deliverables from outside the team? How
likely will those deliverables be ready in a timely manner? (Ranked from
1 (dependencies outside Google) to 5 (no external dependencies).)

\subsubsection{User Impact}
How do we think the user experience will be impacted by this alternative?
(Ranked from 1 (negative impact) to 5 (positive impact).)

\subsubsection{Interest}
Is there someone on the team who is supportive of a particular approach and
willing to do the work to get it done?
(Ranked from 1 (no interest) to 5 (multiple supporters).)

\subsection{Alternatives}
Possible solutions were generated through brainstorming.

\subsubsection{Client-side Audio Syncing}
Synchronize audioswap track and original video playback on the client side,
removing the need for a roundtrip to display the preview for audioswap.

\subsubsection{Do Nothing}
Prioritize other fixes / features instead.

\subsubsection{Real-Time Streaming Preview (WebRTC)}
Replace the video preview player with WebRTC so that we can stream the
preview in real time.

\subsubsection{Throttle Events}
Don't send an edit list to the server for every event. Instead, send one
every $\Delta t$ seconds, as well as one for the "last" event (mouse button up
event).

\subsubsection{Wait for Advances in Networking Technology}
Limit the use of the application to users on super-high-speed network
connections, like Google Fiber.

\subsection{Phase 1: Multi-Criteria Decision Making}
The results of table~\ref{tbl:mcdm} indicate that event throttling is the
best solution. We note that the the solution chosen isn't very robust if
the criteria weights are changed -- in fact, it is possible to make
virtually every solution an "optimal" solution by changing the weights.
However, we proceed with the weights chosen by the team lead, noting that
we should re-evaluate the criteria weights if we need to make a similar
decision in the future.

% Here is a table.  You MUST cite the table in the text before it appears
% in the document.
\begin{table}
  \caption{Multi-Criteria Decision Making Results.}
  \label{tbl:mcdm}
  \centering
  \begin{tabular}{|p{3.0cm}|p{0.75cm}|
                   p{0.75cm}|p{0.75cm}|p{0.75cm}|p{0.75cm}|p{0.75cm}|
                   p{0.75cm}|p{0.75cm}|p{0.75cm}|p{0.75cm}|p{0.75cm}|}
    \hline
    \textbf{Criteria} &
    \textbf{Wt.} &
    \multicolumn{2}{|p{1.50cm}|}{\textbf{Client}} &
    \multicolumn{2}{|p{1.50cm}|}{\textbf{Nothing}} &
    \multicolumn{2}{|p{1.50cm}|}{\textbf{WebRTC}} &
    \multicolumn{2}{|p{1.50cm}|}{\textbf{Throttle}} &
    \multicolumn{2}{|p{1.50cm}|}{\textbf{Wait}} \\
    \hline
    \hline
    Developer Effort &
       2 &  2 &  4 &  5 & 10 &  1 &  2 &  4 &  8 &  5 & 10 \\
    \hline
    PR Impact &
       2 &  3 &  6 &  2 &  4 &  5 & 10 &  3 &  6 &  1 &  2 \\
    \hline
    External Dependencies &
       3 &  2 &  6 &  5 & 15 &  1 &  3 &  5 & 15 &  1 &  3 \\
    \hline
    User Impact &
       2 &  2 &  4 &  3 &  6 &  5 & 10 &  4 &  8 &  1 &  2 \\
    \hline
    Interest &
       1 &  5 &  5 &  1 &  1 &  3 &  3 &  5 &  5 &  1 &  1 \\
    \hline
    \hline
    \textbf{Total} &
      &
      \multicolumn{2}{|r|}{\textbf{25}} &
      \multicolumn{2}{|r|}{\textbf{36}} &
      \multicolumn{2}{|r|}{\textbf{28}} &
      \multicolumn{2}{|r|}{\textbf{42}} &
      \multicolumn{2}{|r|}{\textbf{18}} \\
    \hline
  \end{tabular}
\end{table}

\subsection{Phase 2: Simulation and Optimization}
A number of simulations was performed to determine the best value of
$\Delta t$, the duration between edit lists being sent to the server. A
sample of these simulations is shown below in figure~\ref{fig:sim-300ms},
figure~\ref{fig:sim-600ms}, and figure~\ref{fig:sim-1000ms}. Of the
simulations performed, the value $\Delta t=600 ms$ provided the most
frequent preview updates to the user while maintaining a bounded request
queue size.

\begin{figure}
  \centering
  \includegraphics[width=6.25in]{sim-300ms}
  \caption{Simulated Request Queue Length (300ms delay).}
  \label{fig:sim-300ms}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=6.25in]{sim-600ms}
  \caption{Simulated Request Queue Length (600ms delay).}
  \label{fig:sim-600ms}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=6.25in]{sim-1000ms}
  \caption{Simulated Request Queue Length (1000ms delay).}
  \label{fig:sim-1000ms}
\end{figure}

% You must have a Conclusions section
\section{Conclusions}
The simulation suggests that edit lists should be sent to the front-end
server at most once every 600ms. We note that this value corresponds to the
round-trip time we determined in \S\ref{sec:assumptions}, so we recommend
that an edit list be generated only after the previous one has completed
its round trip,\footnote{With a timeout, of course, and re-transmission
with exponential back-off in the event of packet loss / transient network
failure, etc...} and that UI events only update the UI in the interim.

This provides a bound on the size of the number of requests in the queue.
(Only one request will be processing at any given time.) This, in turn,
gives us a bound on the time between a given user interaction and when the
preview is displayed to the user. (This also reduces the total number of
preview requests sent to the preview server, which results in a
corresponding reduction in CPU and bandwidth usage on the render server.)

% You must have a Recommendations section
\section{Recommendations}
We recommend that the client-side code be modified so that UI events update
the UI immediately, but only trigger a network round-trip if an edit list
is not already in flight.

We note that this recommendation does not necessarily preclude the pursuit
of the other alternatives. Instead, the above alternative should be pursued
first, since it provides the best overall trade-off given the criteria.
Pursuit of the remaining alternative solutions should then be prioritized
within the overall context of the team's objectives and key results (OKRs)
for the quarter.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% BACK MATTER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \backmatter will make the \section commands ignore their numbering,
\backmatter

% Here, we insert a References section, which will be formatted properly.
% The list of works you have referenced should be specified in the preamble.
% In this template, the file is uw-wkrpt-bib.bib.
%
% Note, you will need to process the document in a certain order.  First,
% run LaTeX.  The % first pass will allow LaTeX to build a list of 
% references, it may % emit warning messages such as:
%   LaTeX Warning: Reference `app:gnugpl' on page 4 undefined on input line 277.
%   LaTeX Warning: There were undefined references.
% This is normal.  Now you run BiBTeX in order to generate the proper
% layout for the references.  After this, you run LaTeX once more.
\printbibliography[heading=bibintoc]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \appendix will reset \section numbers and turn them into letters.
%%
%% Don't forget to refer to all your appendices in the main report.
\appendix
\begin{appendices}

\section{Calculating Simulated Server Response Time}\label{app:calculating}
The simulated server response time is comprised by summing multiple
factors, as noted below.

\subsection{Round Trip Time}
Round-trip travel times between three locations in North America and
youtube.com were sampled.

\begin{table}
  \caption{Round Trip Time.}
  \label{tbl:rtt}
  \centering
  \begin{tabular}{|p{2.0cm}|p{2.0cm}|p{2.0cm}|p{2.0cm}|p{2.0cm}|p{2.0cm}|
                   p{2.0cm}|}
    \hline
    \textbf{Location} &
    \textbf{Trial 1} &
    \textbf{Trial 2} &
    \textbf{Trial 3} &
    \textbf{Trial 4} &
    \textbf{Mean} &
    \textbf{Sample StDev} \\
    \hline
    \hline
    Richmond Hill, Ontario &
      7.77 & 7.16 & 6.85 & 7.44 & 7.305 & 0.393 \\
    \hline
    Waterloo, Ontario &
      6.16 & 6.09 & 6.28 & 6.12 & 6.163 & 0.083 \\
    \hline
    Fremont, California &
      1.18 & 1.30 & 1.18 & 1.28 & 1.235 & 0.064 \\
    \hline
    \hline
    \multicolumn{5}{|p{10.0cm}|}{\textbf{Average}} &
      4.901 & 2.759 \\
    \hline
  \end{tabular}
\end{table}

\subsection{Encoding Time}
To protect proprietary design decisions, assume it takes 2000 ms to encode
1000 s (~= 16 minutes) of audio. (Video encoding time is ignored; since
the control only alters the audio track, we assume that existing video
encodes can be reused and multiplexed into the result upon being sent to
the client.) We take the average of the durations of top featured tracks
in the audio enhancement page to get an approximate audio duration of 4
minutes, 53.125 seconds. Based on our assumption, this would take 587 ms
to encode.

\subsection{Wi-Fi}
The use of a wireless network standard such as 802.11n may introduce
additional latency in the HTTP request. The amount of this latency varies
depending on many factors, and could be the subject of its own report. It
is assumed that the user is using a wired connection for the purposes of
this report. It should be noted that the final implementation may need
further adjustment to compensate for the extra latency that users of these
networks will encounter.

\subsection{Other Factors}
It is assumed that other tasks like multiplexing the audio and video
streams on the preview server, and server-side parsing of the edit list
are almost negligible. The duration of these tasks should be dwarfed by
the time taken to encode the audio on the preview server. We add 8 ms of
latency to account for these other factors.

\end{appendices}
\end{document}
